#!/usr/bin/env node
const chalk = require('chalk');
const path = require('path');
const Utils = require('../util/utils.js');
const AppServer = require('../lib/server.js');
const Application = requireApp();

createInstance()
  .then(appInstance => {
    return appInstance.init();
  })
  .then(function(appInstance) {
    const server = new AppServer(appInstance.app, appInstance.settings);

    return server.start();
  })
  .catch(function(err) {
    console.error(chalk.bold.red('   An error occurred while trying to start the application:\n'));
    Utils.showStackTrace(err.stack);
    console.error('');

    process.exit(1);
  });

function createInstance() {
  return new Promise((resolve, reject) => {
    try {
      const appInstance = new Application();
      resolve(appInstance);
    } catch (err) {
      reject(err);
    }
  });
}

function requireApp() {
  const Application = require('../lib/app.js');

  let userDefined = path.join(process.cwd(), 'app.js');
  if (Utils.fileExistsSync(userDefined)) {
    const UserDefinedApp = require(userDefined);
    if (!(UserDefinedApp.prototype instanceof Application)) {
      throw new Error('app.js must export a class which extends the <Application> base class.');
    }

    return UserDefinedApp;
  }

  return Application;
}